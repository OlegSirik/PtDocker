<div class="account-container">
  <div *ngIf="loading" class="loading">Loading account...</div>
  
  <div *ngIf="!loading && account">
    <div class="page-header">
      <h1 class="page-title">{{ account.name }}</h1>
      <div class="path-section">
        <mat-chip-listbox>
          @for (item of path; track item.id; let last = $last) {
            <mat-chip-option (click)="goToAccount(item.id)">
              {{ item.name }}
              @if (!last) { / }
            </mat-chip-option>
          }
        </mat-chip-listbox>
      </div>
    </div>

    <!-- Tabs for Tables -->
    <mat-tab-group>
      <ng-container *ngIf="account.nodeType === 'CLIENT' || account.nodeType === 'GROUP'">
      <mat-tab label="Группы пользователей">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="table-header">
              <h3>Группы</h3>
              <div class="header-actions">
                <button mat-raised-button color="primary" class="add-button" (click)="addGroup()">
                  <mat-icon>add</mat-icon>
                  Добавить
                </button>
              </div>
            </div>
            <table mat-table [dataSource]="groups" class="business-table" *ngIf="!loading">
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Название</th>
                <td mat-cell *matCellDef="let group">{{ group.name }}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>...</th>
                <td mat-cell *matCellDef="let group">
                  <div class="action-buttons">
                    <button mat-button color="primary" class="action-button" (click)="editGroup(group); $event.stopPropagation()">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-button color="warn" class="action-button" (click)="deleteGroup(group); $event.stopPropagation()">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="groupsColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: groupsColumns" 
                  (click)="editGroup(row)" 
                  class="clickable-row"></tr>
            </table>
            <div *ngIf="groups.length === 0" class="empty-message">Группы не найдены</div>
          </mat-card-content>
        </mat-card>
      </mat-tab>
      </ng-container>

      <ng-container *ngIf="account.nodeType === 'CLIENT' || account.nodeType === 'GROUP'">
      <mat-tab label="Аккаунты">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="table-header">
              <h3>Аккаунты</h3>
              <div class="header-actions">
                <button mat-raised-button color="primary" class="add-button" (click)="addAccount()">
                  <mat-icon>add</mat-icon>
                  Добавить
                </button>
              </div>
            </div>
            <table mat-table [dataSource]="accounts" class="business-table" *ngIf="!loading">
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Название</th>
                <td mat-cell *matCellDef="let account">{{ account.name }}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>...</th>
                <td mat-cell *matCellDef="let account">
                  <div class="action-buttons">
                    <button mat-button color="primary" class="action-button" (click)="editAccount(account); $event.stopPropagation()">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-button color="warn" class="action-button" (click)="deleteAccount(account); $event.stopPropagation()">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="accountsColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: accountsColumns" 
                  (click)="editAccount(row)" 
                  class="clickable-row"></tr>
            </table>
            <div *ngIf="accounts.length === 0" class="empty-message">Аккаунты не найдены</div>
          </mat-card-content>
        </mat-card>
      </mat-tab>
      </ng-container>

      <mat-tab label="Products">
        <mat-card class="datatable-card">
          <mat-card-content>
            <!--
            <div class="button-section">
              <button mat-raised-button color="primary" class="add-button" (click)="addProduct()">
                <mat-icon>add</mat-icon>
                Добавить продукт
              </button>
            </div>
          -->
            <div class="table-header">
              <h3>Список доступных продуктов</h3>
            </div>
            <table mat-table [dataSource]="products" class="business-table" *ngIf="!loading">
              <ng-container matColumnDef="roleProductId">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let product">{{ product.roleProductId }}</td>
              </ng-container>

              <ng-container matColumnDef="roleProductName">
                <th mat-header-cell *matHeaderCellDef>Продукт</th>
                <td mat-cell *matCellDef="let product">{{ product.roleProductName }}</td>
              </ng-container>

              <ng-container matColumnDef="canRead">
                <th mat-header-cell *matHeaderCellDef>Чтение</th>
                <td mat-cell *matCellDef="let product">{{ product.canRead ? 'Да' : 'Нет' }}</td>
              </ng-container>

              <ng-container matColumnDef="canQuote">
                <th mat-header-cell *matHeaderCellDef>Котировка</th>
                <td mat-cell *matCellDef="let product">{{ product.canQuote ? 'Да' : 'Нет' }}</td>
              </ng-container>

              <ng-container matColumnDef="canPolicy">
                <th mat-header-cell *matHeaderCellDef>Полис</th>
                <td mat-cell *matCellDef="let product">{{ product.canPolicy ? 'Да' : 'Нет' }}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions-column">Действия</th>
                <td mat-cell *matCellDef="let product" class="actions-column">
                  <button mat-icon-button (click)="editProduct(product); $event.stopPropagation()" color="primary">
                    <mat-icon>edit</mat-icon>
                  </button>
<!--
                  <button mat-icon-button (click)="deleteProduct(product); $event.stopPropagation()" color="warn">
                    <mat-icon>delete</mat-icon>
                  </button>
-->
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="productsColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: productsColumns" class="clickable-row" (click)="editProduct(row)"></tr>
            </table>
            <div *ngIf="products.length === 0" class="empty-message">No products found</div>
          </mat-card-content>
        </mat-card>
      </mat-tab>

      <ng-container *ngIf="account.nodeType === 'ACCOUNT' || account.nodeType === 'SUB'">
      <mat-tab label="Logins">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="button-section">
              <button mat-raised-button color="primary" class="add-button" (click)="addLogin()">
                <mat-icon>add</mat-icon>
                Add Login
              </button>
            </div>
            <div class="table-header">
              <h3>Logins</h3>
            </div>
            <table mat-table [dataSource]="logins" class="business-table" *ngIf="!loading">
              <ng-container matColumnDef="login">
                <th mat-header-cell *matHeaderCellDef>Login</th>
                <td mat-cell *matCellDef="let login">{{ login.userLogin }}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions-column">Actions</th>
                <td mat-cell *matCellDef="let login" class="actions-column">
                  <button mat-icon-button (click)="deleteLogin(login); $event.stopPropagation()" color="warn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="loginsColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: loginsColumns"></tr>
            </table>
            <div *ngIf="logins.length === 0" class="empty-message">No logins found</div>
          </mat-card-content>
        </mat-card>
      </mat-tab>
      </ng-container>

      <ng-container *ngIf="account.nodeType === 'ACCOUNT' || account.nodeType === 'SUB'">
      <mat-tab label="Tokens">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="button-section">
              <button mat-raised-button color="primary" class="add-button" (click)="addToken()">
                <mat-icon>add</mat-icon>
                Add Token
              </button>
            </div>
            <div class="table-header">
              <h3>Tokens</h3>
            </div>
            <table mat-table [dataSource]="tokens" class="business-table" *ngIf="!loading">
              <ng-container matColumnDef="token">
                <th mat-header-cell *matHeaderCellDef>Token</th>
                <td mat-cell *matCellDef="let token">{{ token.token }}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions-column">Actions</th>
                <td mat-cell *matCellDef="let token" class="actions-column">
                  <button mat-icon-button (click)="deleteToken(token); $event.stopPropagation()" color="warn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="tokensColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: tokensColumns"></tr>
            </table>
            <div *ngIf="tokens.length === 0" class="empty-message">No tokens found</div>
          </mat-card-content>
        </mat-card>
      </mat-tab>
      </ng-container>

      <ng-container *ngIf="account.nodeType === 'CLIENT' || account.nodeType === 'GROUP'">
      <mat-tab label="Admins">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="button-section">
              <button mat-raised-button color="primary" class="add-button" (click)="addAdmin()">
                <mat-icon>add</mat-icon>
                Add Admin
              </button>
            </div>
            <div class="table-header">
              <h3>Admins</h3>
            </div>
            <table mat-table [dataSource]="admins" class="business-table" *ngIf="!loading">
              <ng-container matColumnDef="admin">
                <th mat-header-cell *matHeaderCellDef>Admin</th>
                <td mat-cell *matCellDef="let admin; let i = index">{{ admin.userLogin }}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions-column">Actions</th>
                <td mat-cell *matCellDef="let admin; let i = index" class="actions-column">
                  <button mat-icon-button (click)="deleteAdmin(i); $event.stopPropagation()" color="warn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="adminsColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: adminsColumns; let i = index" class="clickable-row" (click)="editAdmin(row, i)"></tr>
            </table>
            <div *ngIf="admins.length === 0" class="empty-message">No admins found</div>
          </mat-card-content>
        </mat-card>
      </mat-tab>
      </ng-container>

      <ng-container *ngIf="account.nodeType === 'ACCOUNT'">
      <mat-tab label="Субаккаунты">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="table-header">
              <h3>Субаккаунты</h3>
              <div class="header-actions">
                <button mat-raised-button color="primary" class="add-button" (click)="addSub()">
                  <mat-icon>add</mat-icon>
                  Добавить
                </button>
              </div>
            </div>
            <table mat-table [dataSource]="subs" class="business-table" *ngIf="!loading">
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Название</th>
                <td mat-cell *matCellDef="let sub">{{ sub.name }}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>...</th>
                <td mat-cell *matCellDef="let sub">
                  <div class="action-buttons">
                    <button mat-button color="primary" class="action-button" (click)="viewAccount(sub); $event.stopPropagation()">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-button color="warn" class="action-button" (click)="deleteSub(sub); $event.stopPropagation()">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="subColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: subColumns" 
                  (click)="viewAccount(row)" 
                  class="clickable-row"></tr>
            </table>
            <div *ngIf="subs.length === 0" class="empty-message">Субаккаунты не найдены</div>
          </mat-card-content>
        </mat-card>
      </mat-tab>
      </ng-container>
    </mat-tab-group>
  
  </div>
</div>

