<div class="calculator-container">
  <div class="page-header">
    <h1 class="page-title">Калькулятор: {{ calculator.productCode }}:{{ calculator.versionNo }}:package{{ calculator.packageNo }}</h1>
    <div class="header-actions">
      <button mat-raised-button color="primary" class="save-button" [disabled]="!hasChanges" (click)="save()">
        <mat-icon>save</mat-icon>
        Save
      </button>
      <button mat-raised-button color="accent" class="json-button" (click)="saveToFile()">
        <mat-icon>file_download</mat-icon>
        File
      </button>
      <button mat-raised-button color="warn" class="json-button" (click)="loadFromFile()">
        <mat-icon>file_upload</mat-icon>
        File
      </button>
    </div>
  </div>

  <mat-tab-group>

    <!-- Constants Tab -->
    <mat-tab label="Тариф">
      <div class="tab-content">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="table-header">
              <h3>Константны тарифа</h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px; padding: 16px;">
              @for (constant of constants; track constant.varCode) {
                <div style="display: flex; align-items: center; gap: 16px; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px;">
                  <div style="flex: 1; font-weight: 500;">
                    {{ constant.varName }}
                  </div>
                  <mat-form-field appearance="outline" style="width: 200px;">
                    <mat-label>Value</mat-label>
                    <input 
                      matInput 
                      [value]="constant.varValue || ''" 
                      (input)="updateConstantValue(constant, $any($event.target).value)"
                      [placeholder]="constant.varDataType === 'NUMBER' ? '0' : ''">
                  </mat-form-field>
                </div>
              }
              @if (constants.length === 0) {
                <div style="text-align: center; padding: 32px; color: #999;">
                  No constants found
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="table-header">
              <h3>Тариф</h3>
            </div>
            <pre>{{ toReadableText() }}</pre>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Formulas Tab -->
    <mat-tab label="Формулы">
      <div class="tab-content">
@if (false) {
        <mat-card class="datatable-card">
          <mat-card-content>
            <table mat-table [dataSource]="paginatedFormulas" class="calculator-table">
              <ng-container matColumnDef="varCode">
                <th mat-header-cell *matHeaderCellDef>Код переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varCode}}</td>
              </ng-container>

              <ng-container matColumnDef="varName">
                <th mat-header-cell *matHeaderCellDef>Название переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varName}}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef style="text-align: right;"></th>
                <td mat-cell *matCellDef="let element; let i = index" style="text-align: right;">
                  <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 8px;">
                    <button mat-button color="primary" matBadge="{{element.lines.length}}" class="action-button1" (click)="showLines(element, i)">
                      lines
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="formulasDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: formulasDisplayedColumns;"></tr>
            </table>
          </mat-card-content>
        </mat-card>
}
        <!-- Lines Card -->
        
          <mat-card class="datatable-card">
            <mat-card-content>
              <div class="table-header">
                <h3>lines</h3>
                <button mat-raised-button color="primary" class="add-button" (click)="addLine()">
                  <mat-icon>add</mat-icon>
                  Добавить
                </button>
              </div>
              <table mat-table [dataSource]="paginatedLines" class="calculator-table">
                <ng-container matColumnDef="nr">
                  <th mat-header-cell *matHeaderCellDef>№</th>
                  <td mat-cell *matCellDef="let element">{{element.nr}}</td>
                </ng-container>
                <ng-container matColumnDef="conditionLeft">
                  <th mat-header-cell *matHeaderCellDef>Условие слева</th>
                  <td mat-cell *matCellDef="let element">
                    <div class="var-cell">
                      <div>{{element.conditionLeft}}</div>
                    </div>
                  </td>
                </ng-container>
                <ng-container matColumnDef="conditionOperator">
                  <th mat-header-cell *matHeaderCellDef>Оператор условия</th>
                  <td mat-cell *matCellDef="let element">{{element.conditionOperator}}</td>
                </ng-container>
                <ng-container matColumnDef="conditionRight">
                  <th mat-header-cell *matHeaderCellDef>Условие справа</th>
                  <td mat-cell *matCellDef="let element">
                    <div class="var-cell">
                      <div>{{element.conditionRight}}</div>
                    </div>
                  </td>
                </ng-container>
                <ng-container matColumnDef="expressionResult">
                  <th mat-header-cell *matHeaderCellDef>Результат выражения</th>
                  <td mat-cell *matCellDef="let element">
                    <div class="var-cell">
                      <div>{{element.expressionResult}}</div>
                    </div>
                  </td>
                </ng-container>
                <ng-container matColumnDef="expressionLeft">
                  <th mat-header-cell *matHeaderCellDef>Выражение слева</th>
                  <td mat-cell *matCellDef="let element">
                    <div class="var-cell">
                      <div>{{element.expressionLeft}}</div>
                    </div>
                  </td>
                </ng-container>
                <ng-container matColumnDef="expressionOperator">
                  <th mat-header-cell *matHeaderCellDef>Оператор выражения</th>
                  <td mat-cell *matCellDef="let element">{{element.expressionOperator}}</td>
                </ng-container>
                <ng-container matColumnDef="expressionRight">
                  <th mat-header-cell *matHeaderCellDef>Выражение справа</th>
                  <td mat-cell *matCellDef="let element">
                    <div class="var-cell">
                      <div>{{element.expressionRight}}</div>
                    </div>
                  </td>
                </ng-container>
                <ng-container matColumnDef="postProcessor">
                  <th mat-header-cell *matHeaderCellDef>Постпроцессор</th>
                  <td mat-cell *matCellDef="let element">{{element.postProcessor || ''}}</td>
                </ng-container>
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef style="text-align: right;"></th>
                  <td mat-cell *matCellDef="let element; let i = index" style="text-align: right;">
                    <div class="action-buttons">
                      <button mat-button color="primary" class="action-button" (click)="editLine(element, i)">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-button color="warn" class="action-button" (click)="deleteLine(element, i)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="linesDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: linesDisplayedColumns;"></tr>
              </table>
              <!--
              <mat-paginator
                [length]="filteredLines.length"
                [pageSize]="linesPageSize"
                [pageIndex]="linesPageIndex"
                [pageSizeOptions]="[5, 10, 25]"
                (page)="onLinesPageChange($event)"
                showFirstLastButtons>
              </mat-paginator>
              -->
              <div class="text-processor-section">
                <div class="text-processor-buttons">
                  <button mat-raised-button color="primary" (click)="toText()">
                    to_text
                  </button>
                  <button mat-raised-button color="primary" (click)="fromText()">
                    from_text
                  </button>
                </div>
                <textarea 
                  class="text-processor-textarea" 
                  [(ngModel)]="textProcessorContent"
                  rows="10"
                  style="width: 100%;">
                </textarea>
              </div>
            </mat-card-content>
          </mat-card>
        
      </div>
    </mat-tab>

    <!-- Coefficients Tab -->
    <mat-tab label="Коэффициенты">
      <div class="tab-content">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="button-section">
              <button mat-raised-button color="primary" class="add-button" (click)="addCoefficient()">
                <mat-icon>add</mat-icon>
                Add coefficients
              </button>
            </div>

            <div class="table-header">
              <h3>coefficients</h3>
            </div>

            <table mat-table [dataSource]="paginatedCoefficients" class="calculator-table">
              <ng-container matColumnDef="varCode">
                <th mat-header-cell *matHeaderCellDef>Код переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varCode}}</td>
              </ng-container>

              <ng-container matColumnDef="varName">
                <th mat-header-cell *matHeaderCellDef>Название переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varName}}</td>
              </ng-container>

              <ng-container matColumnDef="altVarName">
                <th mat-header-cell *matHeaderCellDef>Alt var name</th>
                <td mat-cell *matCellDef="let element">{{element.altVarName}}</td>
              </ng-container>

              <ng-container matColumnDef="altVarValue">
                <th mat-header-cell *matHeaderCellDef>Alt var value</th>
                <td mat-cell *matCellDef="let element">{{element.altVarValue}}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef style="text-align: right;"></th>
                <td mat-cell *matCellDef="let element; let i = index" style="text-align: right;">
                  <div class="action-buttons" (click)="$event.stopPropagation()" style="display: flex; justify-content: flex-end; gap: 8px;">
                    <button mat-button color="primary" class="action-button" (click)="editCoefficient(element, i)">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-button color="warn" class="action-button" (click)="deleteCoefficient(element, i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="coefficientsDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: coefficientsDisplayedColumns;" 
                  (click)="onCoefficientRowClick(row)" 
                  class="clickable-row"></tr>
            </table>
           
          </mat-card-content>
        </mat-card>

        <!-- Columns Card -->
        @if (selectedCoefficientIndex !== -1) {
          <mat-card class="datatable-card">
            <mat-card-content>
              <div class="button-section">
                <button mat-raised-button color="primary" class="add-button" (click)="addColumn()">
                  <mat-icon>add</mat-icon>
                  Add column
                </button>
              </div>
              <div class="table-header">
                <h3>Columns: {{ selectedColumnCoefficientCode }}</h3>
              </div>
              <table mat-table [dataSource]="paginatedColumns" class="calculator-table">
                <ng-container matColumnDef="nr">
                  <th mat-header-cell *matHeaderCellDef>Колонка №</th>
                  <td mat-cell *matCellDef="let element">{{element.nr}}</td>
                </ng-container>
                <ng-container matColumnDef="conditionOperator">
                  <th mat-header-cell *matHeaderCellDef>Оператор условия</th>
                  <td mat-cell *matCellDef="let element">{{element.conditionOperator}}</td>
                </ng-container>
                <ng-container matColumnDef="varCode">
                  <th mat-header-cell *matHeaderCellDef>Код переменной</th>
                  <td mat-cell *matCellDef="let element">{{element.varCode}}</td>
                </ng-container>
                <ng-container matColumnDef="sortOrder">
                  <th mat-header-cell *matHeaderCellDef>Порядок сортировки</th>
                  <td mat-cell *matCellDef="let element">{{element.sortOrder}}</td>
                </ng-container>
                <ng-container matColumnDef="varName">
                  <th mat-header-cell *matHeaderCellDef>Тип данных</th>
                  <td mat-cell *matCellDef="let element">{{element.varDataType}}</td>
                </ng-container>
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef style="text-align: right;"></th>
                  <td mat-cell *matCellDef="let element; let i = index" style="text-align: right;">
                    <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 8px;">
                      <button mat-button color="primary" class="action-button" (click)="editColumn(element, i)">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-button color="warn" class="action-button" (click)="deleteColumn(element, i)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="columnsDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: columnsDisplayedColumns;"></tr>
              </table>
            </mat-card-content>
          </mat-card>
        }

        <!-- Coefficient Data Card -->
        @if (coefficientDataVisible) {
          <mat-card class="datatable-card">
            <mat-card-content>
              <div class="button-section" style="display: flex; justify-content: flex-end; gap: 8px; align-items: center;">
                <button mat-raised-button color="primary" class="add-button" (click)="exportCoefficientDataCsv()">
                  <mat-icon>file_download</mat-icon>
                  To Excel
                </button>
                <button mat-raised-button color="warn" class="add-button" (click)="importCoefficientDataCsv()">
                  <mat-icon>file_upload</mat-icon>
                  From Excel
                </button>
                <button mat-raised-button color="accent" class="add-button" (click)="saveCoefficientData()">
                  <mat-icon>save</mat-icon>
                  Save
                </button>
              </div>
              <div class="table-header">
                <h3>coefficient: {{ selectedCoefficientCode }}</h3>
                <mat-form-field class="search-field" appearance="outline">
                  <mat-label>Поиск</mat-label>
                  <input matInput [(ngModel)]="coefficientDataSearchText" (ngModelChange)="updateCoefficientDataTable()" placeholder="Поиск">
                  <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>
              </div>
              <table mat-table [dataSource]="paginatedCoefficientData" class="calculator-table">
                @for (col of coefficientDataColumns; track col) {
                  <ng-container [matColumnDef]="col">
                    <th mat-header-cell *matHeaderCellDef>{{ getCoefficientDataHeader(col) }}</th>
                    <td mat-cell *matCellDef="let row">{{ getCoefficientDataCell(row, col) }}</td>
                  </ng-container>
                }
                <tr mat-header-row *matHeaderRowDef="coefficientDataColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: coefficientDataColumns;"></tr>
              </table>
              <mat-paginator
                [length]="filteredCoefficientData.length"
                [pageSize]="coefficientDataPageSize"
                [pageIndex]="coefficientDataPageIndex"
                [pageSizeOptions]="[5, 10, 25]"
                (page)="onCoefficientDataPageChange($event)"
                showFirstLastButtons>
              </mat-paginator>
            </mat-card-content>
          </mat-card>
        }
      </div>
    </mat-tab>

    <!-- Vars Tab -->
    <mat-tab label="Переменные">
      <div class="tab-content">
        <mat-card class="datatable-card">
          <mat-card-content>
            <div class="button-section">
              <div class="button-section" style="display: flex; gap: 12px;">
                <button mat-raised-button color="primary" class="add-button" (click)="addVar()">
                  <mat-icon>add</mat-icon>
                  Add var
                </button>
                <button mat-raised-button color="primary" class="add-button" (click)="syncVars()">
                  <mat-icon>sync</mat-icon>
                  Sync vars
                </button>
              </div>
            </div>

            <div class="table-header">
              <h3>List of variables</h3>
              <mat-form-field class="search-field" appearance="outline">
                <mat-label>Поиск</mat-label>
                <input matInput [(ngModel)]="varsSearchText" (ngModelChange)="updateVarsTable()" placeholder="Поиск">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
            </div>

            <table mat-table [dataSource]="paginatedVars" class="calculator-table">
              <ng-container matColumnDef="varCode">
                <th mat-header-cell *matHeaderCellDef>Код переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varCode}}</td>
              </ng-container>

              <ng-container matColumnDef="varName">
                <th mat-header-cell *matHeaderCellDef>Название переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varName}}</td>
              </ng-container>

              <ng-container matColumnDef="varPath">
                <th mat-header-cell *matHeaderCellDef>Путь переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varPath}}</td>
              </ng-container>

              <ng-container matColumnDef="varType">
                <th mat-header-cell *matHeaderCellDef>Тип переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varType}}</td>
              </ng-container>

              <ng-container matColumnDef="varDataType">
                <th mat-header-cell *matHeaderCellDef>Тип данных</th>
                <td mat-cell *matCellDef="let element">{{element.varDataType}}</td>
              </ng-container>

              <ng-container matColumnDef="varValue">
                <th mat-header-cell *matHeaderCellDef>Значение переменной</th>
                <td mat-cell *matCellDef="let element">{{element.varValue || ''}}</td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef style="text-align: right;"></th>
                <td mat-cell *matCellDef="let element; let i = index" style="text-align: right;">
                  <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 8px;">
                    <button mat-button color="primary" class="action-button" (click)="editVar(element, i)">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-button color="warn" class="action-button" (click)="deleteVar(element, i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="varsDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: varsDisplayedColumns;"></tr>
            </table>

            <mat-paginator
              [length]="filteredVars.length"
              [pageSize]="varsPageSize"
              [pageIndex]="varsPageIndex"
              [pageSizeOptions]="[10, 50, 100]"
              (page)="onVarsPageChange($event)"
              showFirstLastButtons>
            </mat-paginator>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>


  </mat-tab-group>
</div>
